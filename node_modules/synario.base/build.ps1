$workdir = $PSScriptRoot
echo "get module location:  $workdir"
echo "Building localts..."

rm $workdir\dist\*,$workdir\types\* -r -fo
echo "removed dist and types"
# return
tsc -p $workdir\tsconfig.json

echo 'build typescript module localts done'

# 重写index.ts中的内容让它生成的语句与src中的所有文件一样，导出所有的内容

$srcDir = "$workdir\\src\\"
$indexts = "$workdir\\index.ts"

$files = Get-ChildItem $srcDir -Recurse -Include *.ts
$exportStr = ""
# version = date yyMMdd.HH
$version = Get-Date -Format "yyMMdd.HH"
$exportStr += "export const version = '$version';`n"
$exportStr += "export const moduleCount = $($files.Count);`n" 

foreach ($file in $files) {
  $name=$file.Name -replace ".ts$",""
  $importname=$name -replace "-","_"
  $importname="$($importname)_mod"
  $exportStr += "export * as $importname from './src/" + $name + "';`n"
}

$exportStr | Out-File -FilePath $indexts -Encoding utf8


echo "rewrite index.ts done"
